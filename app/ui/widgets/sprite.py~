import pygame
from ui.utils.interpolator import Interpolator
from pygame.font import Font

class LcarsWidget(pygame.sprite.DirtySprite):
    """Base class for all widgets"""

    def __init__(self, color, pos, size, handler=None):
        pygame.sprite.DirtySprite.__init__(self)
        if self.image == None:
            self.image = pygame.Surface(size).convert()
            self.image.fill(color)

        self.rect = self.image.get_rect()
        self.rect.top = pos[0]
        self.rect.left = pos[1]
        self.size = (self.rect.width, self.rect.height)

        self.long_pressed = False
        self.pressed_time = 0            
        self.focussed = False
        self.line = None
        self.handler = handler
        self.emf_scanning = False
        self.select_x = 0
        self.select_y = 0
        

    def update(self, screen):
        if not self.visible:
            return
        
        if self.line != None:
            self.line.next()
            if self.rect.center == self.line.pos:
                self.dirty = 0
                
            self.rect.center = self.line.pos
        else:
            self.dirty = 0
            
        if self.emf_scanning:
            self.image = pygame.image.load("/home/tricorder/rpi_lcars-master/spectrum.png")

        screen.blit(self.image, self.rect)
        if self.emf_scanning and self.select_x != 0:
            pygame.draw.rect(screen, (255,255,0), (self.select_x-50,self.select_y-50,100,3))
            pygame.draw.rect(screen, (255,255,0), (self.select_x-50,self.select_y+50,100,3))
            pygame.draw.rect(screen, (255,255,0), (self.select_x-50,self.select_y-50,3,100))
            pygame.draw.rect(screen, (255,255,0), (self.select_x+50,self.select_y-50,3,100))
            pygame.draw.rect(screen, (255,255,0), (self.select_x,self.select_y-50,3,100))
            font = Font("assets/swiss911.ttf", 19)
            
            #screen_w = 480
            #screen_h = 640
            #screen_x = 187 # where the display screen is
            #screen_y = 299
            #f_min = 87 #85.7
            #f_max = 103 #104.2
            #r = (self.select_x - screen_x)/screen_w
            
            f_min = 85.7
            f_max = 104.2
            r = (self.select_x - 350)/550
            f = f_min + r*(f_max-f_min)
            self.target_frequency = f
            
            freq = self.select_x
            text = font.render(str("%.1f" % f), False, (255,255,0))
            screen.blit(text,(1280/2,720-50))

    def handleEvent(self, event, clock):
        handled = False
        if not self.visible:
            self.focussed = False
            return handled
        
        if event.type == pygame.MOUSEBUTTONDOWN:
            self.pressed_time = pygame.time.get_ticks()
            x, y = event.pos
            if self.emf_scanning:
                print("EMF",x,y)
                self.select_x = x
                self.select_y = y
            self.focussed = True
                
        if event.type == pygame.MOUSEMOTION:
            if (self.focussed and pygame.time.get_ticks() - self.pressed_time > 1000):
                self.long_pressed = True
                if self.groups()[0].UI_PLACEMENT_MODE:
                    self.rect.top = event.pos[1]
                    self.rect.left = event.pos[0]
                    self.dirty = 1            

        if event.type == pygame.MOUSEBUTTONUP:
            if self.handler:
                self.handler(self, event, clock)
                handled = True
            
            if self.focussed and self.long_pressed and self.groups()[0].UI_PLACEMENT_MODE:
                print(event.pos[1], event.pos[0])
                
            self.pressed_time = 0
            self.long_pressed = False
            self.focussed = False
                
        return handled

    def applyColour(self, colour):
        """Convert non-black areas of an image to specified colour"""
        for x in range(0, self.size[0]):
            for y in range(0, self.size[1]):
                pixel = self.image.get_at((x, y)).r
                if (pixel > 50):
                    self.image.set_at((x, y), colour)

class LcarsMoveToMouse(LcarsWidget):
    """For testing purposes - move a small square to last clicked position"""
    def __init__(self, color):
        self.image = None
        LcarsWidget.__init__(self, color, (0,0), (10,10))
        self.focussed = True

    def handleEvent(self, event, clock):
        if event.type == pygame.MOUSEBUTTONDOWN:
            # move sprite to clicked location using interpolator
            fps = clock.get_fps()
            x, y = event.pos
            
            self.line = Interpolator(
                self.rect.center,
                (x, y),
                0.5, # duration of interpolation
                fps, # current frames per second
                1.0, # type of interpolation
                0.5  # middle?
            )
            
            self.dirty = 1
    
